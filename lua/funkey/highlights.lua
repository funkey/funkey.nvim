local p = require("funkey.palette")
local utils = require("funkey.utils")
local config = require("funkey.config")
local terminal = require("funkey.terminal")

local M = {}

local function load_highlights(highlights)
    for group_name, group_settings in pairs(highlights) do
        vim.api.nvim_set_hl(0, group_name, group_settings)
    end
end

local styles = vim.tbl_map(function(value)
    return setmetatable(value, {
        __add = function(a, b)
            return vim.tbl_extend("force", a, b)
        end,
    })
end, config.styles)

local transparent_bg = setmetatable({}, {
    __add = function(a)
        a.bg = config.transparent_background and p.none or a.bg
        return a
    end,
})

local function gamma(value)
    return setmetatable({}, {
        __add = function(a)
            return utils.color_gamma(a, value)
        end,
    })
end

M.highlights = {
    Normal = { fg = p.text, bg = p.bg0 } + transparent_bg,
    NormalNC = { fg = p.text, bg = p.bg0 } + transparent_bg,
    NormalSB = { fg = p.text, bg = p.bg0 } + transparent_bg,
    NormalFloat = { fg = p.text, bg = p.bg0 } + transparent_bg,
    Terminal = { fg = p.text, bg = p.bg0 } + transparent_bg,
    EndOfBuffer = { fg = p.bg2, bg = p.bg0 } + transparent_bg,
    FoldColumn = { fg = p.text, bg = p.bg1 } + transparent_bg,
    Folded = { fg = p.text, bg = p.bg1 } + transparent_bg,
    SignColumn = { fg = p.text, bg = p.bg0 } + transparent_bg,
    ToolbarLine = { fg = p.text },
    Cursor = { reverse = true },
    vCursor = { reverse = true },
    iCursor = { reverse = true },
    lCursor = { reverse = true },
    CursorIM = { reverse = true },
    CursorColumn = { bg = p.bg1 },
    CursorLine = { bg = p.bg1 },
    ColorColumn = { bg = p.bg1 },
    CursorLineNr = { fg = p.text },
    LineNr = { fg = p.bg4 },
    Conceal = { fg = p.grey, bg = p.bg1 } + transparent_bg,
    DiffAdd = { fg = p.none, bg = p.diff_add },
    DiffChange = { fg = p.none, bg = p.diff_change },
    DiffDelete = { fg = p.none, bg = p.diff_delete },
    DiffText = { fg = p.none, bg = p.diff_change },
    Directory = { fg = p.green },
    ErrorMsg = { fg = p.error, bold = true, underline = true },
    WarningMsg = { fg = p.warning, bold = true },
    MoreMsg = { fg = p.blue, bold = true },
    IncSearch = { fg = p.bg0, bg = p.highlight },
    Search = { fg = p.bg0, bg = p.highlight_secondary },
    CurSearch = { fg = p.bg0, bg = p.highlight },
    MatchParen = { fg = p.highlight, bold = true },
    NonText = { fg = p.bg4 },
    Whitespace = { fg = p.bg4 },
    SpecialKey = { fg = p.bg4 },
    Pmenu = { fg = p.text, bg = p.bg0 },
    PmenuSbar = { fg = p.none, bg = p.bg0 },
    PmenuSel = { fg = p.bg0, bg = p.highlight_secondary },
    PmenuThumb = { fg = p.none, bg = p.bg2 },
    WildMenu = { fg = p.bg0, bg = p.blue },
    Question = { fg = p.yellow },
    SpellBad = { fg = p.warning, underline = true, sp = p.warning },
    SpellCap = { fg = p.yellow, underline = true, sp = p.yellow },
    SpellLocal = { fg = p.blue, underline = true, sp = p.blue },
    SpellRare = { fg = p.purple, underline = true, sp = p.purple },
    StatusLine = { fg = p.text, bg = p.bg2 },
    StatusLineTerm = { fg = p.text, bg = p.bg2 },
    StatusLineNC = { fg = p.grey, bg = p.bg1 },
    StatusLineTermNC = { fg = p.grey, bg = p.bg1 },
    TabLine = { fg = p.text, bg = p.bg4 },
    TabLineFill = { fg = p.grey, bg = p.bg1 },
    TabLineSel = { fg = p.bg0, bg = p.highlight },
    WinSeparator = { fg = p.bg5 },
    VertSplit = { fg = p.bg5 },
    Visual = { bg = p.bg2 },
    VisualNOS = { fg = p.none, bg = p.bg2, underline = true },
    QuickFixLine = { fg = p.blue, underline = true },
    Debug = { fg = p.yellow },
    debugPC = { fg = p.bg0, bg = p.green },
    debugBreakpoint = { fg = p.bg0, bg = p.highlight },
    ToolbarButton = { fg = p.bg0, bg = p.button },
    FocusedSymbol = { bg = p.bg3 },
    FloatBorder = { fg = p.bg4 },
    FloatTitle = { fg = p.blue },

    Type = { fg = p.type } + styles.keywords,
    Structure = { fg = p.text } + styles.keywords,
    StorageClass = { fg = p.highlight } + styles.keywords,
    Identifier = { fg = p.text } + styles.identifiers,
    Constant = { fg = p.constant } + styles.variables,
    PreProc = { fg = p.keyword },
    PreCondit = { fg = p.keyword },
    Include = { fg = p.keyword },
    Keyword = { fg = p.keyword } + styles.keywords,
    Define = { fg = p.keyword },
    Typedef = { fg = p.keyword },
    Exception = { fg = p.keyword },
    Conditional = { fg = p.keyword },
    Repeat = { fg = p.keyword },
    Statement = { fg = p.keyword },
    Macro = { fg = p.highlight },
    Error = { fg = p.error },
    Label = { fg = p.hint },
    Special = { fg = p.constant },
    SpecialChar = { fg = p.constant },
    Boolean = { fg = p.constant },
    String = { fg = p.constant },
    Character = { fg = p.constant },
    Number = { fg = p.constant },
    Float = { fg = p.constant },
    Function = { fg = p.highlight } + styles.functions,
    FunctionCall = { fg = p.text } + styles.functions,
    Method = { fg = p.text } + styles.functions,
    MethodCall = { fg = p.text } + styles.functions,
    Constructor = { fg = p.type } + styles.functions,
    Operator = { fg = p.operator },
    Title = { fg = p.highlight },
    Tag = { fg = p.highlight },
    Delimiter = { fg = p.text_darker },
    Comment = { fg = p.comment } + styles.comments,
    SpecialComment = { fg = p.bg4 } + styles.comments,
    Todo = { fg = p.highlight } + styles.comments,

    -- whichkey
    WhichKey = { fg = p.replaceme },
    WhichKeyDesc = { fg = p.blue },
    WhichKeyGroup = { fg = p.orange },
    WhichKeySeperator = { fg = p.green },

    -- flash
    FlashBackdrop = { fg = p.bg4 },
    FlashLabel = { fg = p.bg0, bg = p.blue, bold = true },

    -- gitgutter
    GitGutterAdd = { fg = p.diff_add },
    GitGutterChange = { fg = p.diff_change },
    GitGutterDelete = { fg = p.diff_delete },

    -- diffview
    DiffviewFilePanelTitle = { fg = p.blue, bold = true },
    DiffviewFilePanelCounter = { fg = p.purple, bold = true },
    DiffviewFilePanelFileName = { fg = p.text },
    DiffviewNormal = { link = "Normal" },
    DiffviewCursorLine = { link = "CursorLine" },
    DiffviewVertSplit = { link = "VertSplit" },
    DiffviewSignColumn = { link = "SignColumn" },
    DiffviewStatusLine = { link = "StatusLine" },
    DiffviewStatusLineNC = { link = "StatusLineNC" },
    DiffviewEndOfBuffer = { link = "EndOfBuffer" },
    DiffviewFilePanelRootPath = { fg = p.grey },
    DiffviewFilePanelPath = { fg = p.grey },
    DiffviewFilePanelInsertions = { fg = p.diff_add },
    DiffviewFilePanelDeletions = { fg = p.diff_delete },
    DiffviewStatusAdded = { fg = p.diff_add },
    DiffviewStatusUntracked = { fg = p.blue },
    DiffviewStatusModified = { fg = p.blue },
    DiffviewStatusRenamed = { fg = p.blue },
    DiffviewStatusCopied = { fg = p.blue },
    DiffviewStatusTypeChange = { fg = p.blue },
    DiffviewStatusUnmerged = { fg = p.blue },
    DiffviewStatusUnknown = { fg = p.diff_change },
    DiffviewStatusDeleted = { fg = p.diff_delete },
    DiffviewStatusBroken = { fg = p.diff_change },

    -- comments
    commentTSDanger = { fg = p.replaceme } + styles.comments,
    commentTSNote = { fg = p.highlight } + styles.comments,
    commentTSWarning = { fg = p.warning } + styles.comments,
    -- and special keys for todo-comments
    DiagnosticError = { fg = p.error, italic = true },
    DiagnosticWarn = { fg = p.warning, italic = true },
    DiagnosticInfo = { fg = p.info, italic = true },
    DiagnosticHint = { fg = p.hint, italic = true },

    -- treesitter
    ["@annotation"] = { link = "PreProc", default = true },
    ["@attribute"] = { link = "PreProc", default = true },
    ["@boolean"] = { link = "Boolean", default = true },
    ["@character"] = { link = "Character", default = true },
    ["@character.special"] = { link = "SpecialChar", default = true },
    ["@comment"] = { link = "Comment", default = true },
    ["@conditional"] = { link = "Conditional", default = true },
    ["@constant"] = { link = "Constant", default = true },
    ["@constant.builtin"] = { link = "Special", default = true },
    ["@constant.macro"] = { link = "Define", default = true },
    ["@constructor"] = { link = "Constructor", default = true },
    ["@debug"] = { link = "Debug", default = true },
    ["@define"] = { link = "Define", default = true },
    ["@defaultLibrary"] = { link = "Special", default = true },
    ["@error"] = { link = "Error", default = true },
    ["@exception"] = { link = "Exception", default = true },
    ["@field"] = { link = "Identifier", default = true },
    ["@float"] = { link = "Float", default = true },
    ["@function"] = { link = "Function", default = true },
    ["@function.builtin"] = { link = "Special", default = true },
    ["@function.call"] = { link = "FunctionCall", default = true },
    ["@function.macro"] = { link = "Macro", default = true },
    ["@function.method"] = { link = "Method", default = true },
    ["@function.method.call"] = { link = "MethodCall", default = true },
    ["@include"] = { link = "Include", default = true },
    ["@keyword"] = { link = "Keyword", default = true },
    ["@keyword.function"] = { link = "Keyword", default = true },
    ["@keyword.operator"] = { link = "@operator", default = true },
    ["@keyword.return"] = { link = "@keyword", default = true },
    ["@label"] = { link = "Label", default = true },
    ["@method"] = { link = "Method", default = true },
    ["@method.call"] = { link = "MethodCall", default = true },
    ["@namespace"] = { link = "Include", default = true },
    ["@none"] = { bg = "NONE", fg = "NONE", default = true },
    ["@number"] = { link = "Number", default = true },
    ["@operator"] = { link = "Operator", default = true },
    ["@parameter"] = { link = "Identifier", default = true },
    ["@parameter.reference"] = { link = "@parameter", default = true },
    ["@preproc"] = { link = "PreProc", default = true },
    ["@property"] = { link = "Identifier", default = true },
    ["@punctuation.bracket"] = { link = "Delimiter", default = true },
    ["@punctuation.delimiter"] = { link = "Delimiter", default = true },
    ["@punctuation.special"] = { link = "Delimiter", default = true },
    ["@repeat"] = { link = "Repeat", default = true },
    ["@storageclass"] = { link = "StorageClass", default = true },
    ["@string"] = { link = "String", default = true },
    ["@string.escape"] = { link = "SpecialChar", default = true },
    ["@string.regex"] = { link = "String", default = true },
    ["@string.special"] = { link = "SpecialChar", default = true },
    ["@symbol"] = { link = "Identifier", default = true },
    ["@tag"] = { link = "Label", default = true },
    ["@tag.attribute"] = { link = "@property", default = true },
    ["@tag.delimiter"] = { link = "Delimiter", default = true },
    ["@text"] = { link = "@none", default = true },
    ["@text.danger"] = { link = "WarningMsg", default = true },
    ["@text.emphasis"] = { italic = true, default = true },
    ["@text.environment"] = { link = "Macro", default = true },
    ["@text.environment.name"] = { link = "Type", default = true },
    ["@text.literal"] = { link = "String", default = true },
    ["@text.math"] = { link = "Special", default = true },
    ["@text.note"] = { link = "SpecialComment", default = true },
    ["@text.reference"] = { link = "Constant", default = true },
    ["@text.strike"] = { strikethrough = true, default = true },
    ["@text.strong"] = { bold = true, default = true },
    ["@text.title"] = { link = "Title", default = true },
    ["@text.todo"] = { link = "Todo", default = true },
    ["@text.underline"] = { underline = true, default = true },
    ["@text.uri"] = { link = "Underlined", default = true },
    ["@text.warning"] = { link = "Todo", default = true },
    ["@todo"] = { link = "Todo", default = true },
    ["@type"] = { link = "Type", default = true },
    ["@type.builtin"] = { link = "Type", default = true },
    ["@type.definition"] = { link = "Typedef", default = true },
    ["@type.qualifier"] = { link = "Type", default = true },
    ["@variable"] = { fg = p.text, default = true } + styles.variables,
    ["@variable.builtin"] = { fg = p.purple, default = true },

    -- lsp
    LspCxxHlGroupEnumConstant = { fg = p.orange },
    LspCxxHlGroupMemberVariable = { fg = p.orange },
    LspCxxHlGroupNamespace = { fg = p.blue },
    LspCxxHlSkippedRegion = { fg = p.grey },
    LspCxxHlSkippedRegionBeginEnd = { fg = p.replaceme },
    LspDiagnosticsDefaultError = { fg = p.error },
    LspDiagnosticsDefaultHint = { fg = p.hint },
    LspDiagnosticsDefaultInformation = { fg = p.info },
    LspDiagnosticsDefaultWarning = { fg = p.warning },
    LspDiagnosticsUnderlineError = { underline = true, sp = p.error },
    LspDiagnosticsUnderlineHint = { underline = true, sp = p.hint },
    LspDiagnosticsUnderlineInformation = { underline = true, sp = p.info },
    LspDiagnosticsUnderlineWarning = { underline = true, sp = p.warning },
    DiagnosticSignError = { fg = p.error },
    DiagnosticSignHint = { fg = p.hint },
    DiagnosticSignInfo = { fg = p.info },
    DiagnosticSignWarn = { fg = p.warning },
    LspReferenceRead = { bg = p.bg3 },
    LspReferenceWrite = { bg = p.bg3 },
    LspReferenceText = { bg = p.bg3 },
    LspInfoBorder = { fg = p.bg4 },

    -- lsp semantic tokens
    LspNamespace = { link = "@namespace" },
    LspType = { link = "@type" },
    LspClass = { link = "@type" },
    LspEnum = { link = "@constant" },
    LspInterface = { link = "@constant" },
    LspStruct = { link = "@constant" },
    LspTypeParameter = { link = "@type" },
    LspParameter = { link = "@parameter" },
    LspVariable = { link = "@variable" },
    LspProperty = { link = "@property" },
    LspEnumMember = { link = "@constant" },
    LspEvent = { link = "@constant" },
    LspFunction = { link = "@function" },
    LspMethod = { link = "@method" },
    LspMacro = { link = "@constant.macro" },
    LspKeyword = { link = "@keyword" },
    LspModifier = { link = "TSModifier" },
    LspComment = { link = "@comment" },
    LspString = { link = "@string" },
    LspNumber = { link = "@number" },
    LspRegexp = { link = "@string.regex" },
    LspOperator = { link = "@operator" },
    LspDecorator = { link = "@symbol" },
    LspDeprecated = { link = "@text.strike" },
    ["@lsp.type.namespace"] = { link = "@namespace", default = true },
    ["@lsp.type.type"] = { link = "@type", default = true },
    ["@lsp.type.class"] = { link = "@type", default = true },
    ["@lsp.type.enum"] = { link = "@type", default = true },
    ["@lsp.type.interface"] = { link = "@type", default = true },
    ["@lsp.type.struct"] = { link = "@structure", default = true },
    ["@lsp.type.parameter"] = { link = "@parameter", default = true },
    ["@lsp.type.variable"] = { link = "@variable", default = true },
    ["@lsp.type.property"] = { link = "@property", default = true },
    ["@lsp.type.enumMember"] = { link = "@constant", default = true },
    ["@lsp.type.function"] = { link = "@function", default = true },
    ["@lsp.type.method"] = { link = "@method", default = true },
    ["@lsp.type.macro"] = { link = "@macro", default = true },
    ["@lsp.type.decorator"] = { link = "@function", default = true },

    -- cmp
    CmpItemKindDefault = { fg = p.blue },
    CmpItemAbbrMatch = { fg = p.blue },
    CmpItemAbbrMatchFuzzy = { fg = p.blue },
    CmpItemKindKeyword = { fg = p.text },
    CmpItemKindVariable = { fg = p.cyan },
    CmpItemKindConstant = { fg = p.cyan },
    CmpItemKindReference = { fg = p.cyan },
    CmpItemKindValue = { fg = p.cyan },
    CmpItemKindFunction = { fg = p.purple },
    CmpItemKindMethod = { fg = p.purple },
    CmpItemKindConstructor = { fg = p.purple },
    CmpItemKindClass = { fg = p.yellow },
    CmpItemKindInterface = { fg = p.yellow },
    CmpItemKindStruct = { fg = p.yellow },
    CmpItemKindEvent = { fg = p.yellow },
    CmpItemKindEnum = { fg = p.yellow },
    CmpItemKindUnit = { fg = p.yellow },
    CmpItemKindModule = { fg = p.yellow },
    CmpItemKindProperty = { fg = p.green },
    CmpItemKindField = { fg = p.green },
    CmpItemKindTypeParameter = { fg = p.green },
    CmpItemKindEnumMember = { fg = p.green },
    CmpItemKindOperator = { fg = p.green },
    CmpItemKindSnippet = { fg = p.replaceme },

    -- coc
    CocErrorSign = { fg = p.error + gamma(0.5) },
    CocHintSign = { fg = p.hint + gamma(0.5) },
    CocInfoSign = { fg = p.info + gamma(0.5) },
    CocWarningSign = { fg = p.warning + gamma(0.5) },
    FgCocErrorFloatBgCocFloating = { fg = p.error + gamma(0.5), bg = p.bg2 },
    FgCocHintFloatBgCocFloating = { fg = p.hint + gamma(0.5), bg = p.bg2 },
    FgCocInfoFloatBgCocFloating = { fg = p.info + gamma(0.5), bg = p.bg2 },
    FgCocWarningFloatBgCocFloating = { fg = p.warning + gamma(0.5), bg = p.bg2 },

    -- gitsigns
    GitSignsAdd = { fg = p.diff_add },
    GitSignsAddLn = { fg = p.diff_add },
    GitSignsAddNr = { fg = p.diff_add },
    GitSignsChange = { fg = p.diff_change },
    GitSignsChangeLn = { fg = p.diff_change },
    GitSignsChangeNr = { fg = p.diff_change },
    GitSignsDelete = { fg = p.diff_delete },
    GitSignsDeleteLn = { fg = p.diff_delete },
    GitSignsDeleteNr = { fg = p.diff_delete },

    -- telescope
    TelescopeBorder = { link = "FloatBorder" },
    TelescopePreviewBorder = { fg = p.bg4 },
    TelescopePreviewTitle = { fg = p.blue },
    TelescopePromptBorder = { fg = p.bg4 },
    TelescopePromptTitle = { fg = p.blue },
    TelescopeResultsBorder = { fg = p.bg4 },
    TelescopeResultsTitle = { fg = p.blue },

    -- markdown
    markdownBlockquote = { fg = p.grey },
    markdownBold = { fg = p.none, bold = true },
    markdownBoldDelimiter = { fg = p.grey },
    markdownCode = { fg = p.yellow },
    markdownCodeBlock = { fg = p.yellow },
    markdownCodeDelimiter = { fg = p.grey },
    markdownH1 = { fg = p.yellow, bold = true },
    markdownH2 = { fg = p.yellow, bold = true },
    markdownH3 = { fg = p.yellow, bold = true },
    markdownH4 = { fg = p.yellow, bold = true },
    markdownH5 = { fg = p.yellow, bold = true },
    markdownH6 = { fg = p.yellow, bold = true },
    markdownHeadingDelimiter = { fg = p.grey },
    markdownHeadingRule = { fg = p.grey },
    markdownId = { fg = p.yellow },
    markdownIdDeclaration = { fg = p.yellow },
    markdownItalic = { fg = p.none, italic = true },
    markdownItalicDelimiter = { fg = p.grey, italic = true },
    markdownLinkDelimiter = { fg = p.grey },
    markdownLinkText = { fg = p.purple, underline = true },
    markdownLinkTextDelimiter = { fg = p.grey },
    markdownListMarker = { fg = p.purple },
    markdownOrderedListMarker = { fg = p.purple },
    markdownRule = { fg = p.purple },
    markdownUrl = { fg = p.blue, underline = true },
    markdownUrlDelimiter = { fg = p.grey },
    markdownUrlTitleDelimiter = { fg = p.purple },
    ["@markup"] = { link = "@none" },
    ["@markup.heading"] = { fg = p.yellow, bold = true },
    ["@markup.link.label"] = { fg = p.purple, underline = true },
    ["@markup.link.url"] = { fg = p.blue, underline = true },
    ["@markup.list"] = { fg = p.purple },
    ["@markup.list.checked"] = { fg = p.blue },
    ["@markup.list.unchecked"] = { fg = p.blue },
    ["@markup.strikethrough"] = { strikethrough = true },
    ["@markup.strong"] = { bold = true },
    ["@markup.italic"] = { italic = true },
    ["@markup.underline"] = { underline = true },

    -- scala
    scalaNameDefinition = { fg = p.text },
    scalaInterpolationBoundary = { fg = p.purple },
    scalaInterpolation = { fg = p.purple },
    scalaTypeOperator = { fg = p.operator },
    scalaOperator = { fg = p.operator },
    scalaKeywordModifier = { fg = p.keyword },
}

function M.setup()
    local highlights = type(config.custom_highlights) == "function"
        and config.custom_highlights(M.highlights, p)
        or config.custom_highlights
    load_highlights(vim.tbl_extend("force", M.highlights, highlights))
    if config.terminal_colors then
        terminal.setup()
    end
end

return M
